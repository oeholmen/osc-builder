<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>OSC</title>
    <style>
        body {
            background-color: steelblue;
        }

        * {
            font-family: Courier, monospace;
        }

        .wrapper, #patch {
            display: flex;
            flex: auto;
        }

        .wrapper.selected {
            background-color: lightgreen;
        }

        .arg, .name, .desc, #prompt, #promptSubmit {
            border-radius: 1rem;
            margin: .6rem;
            padding: .6rem;
            border: none;
            width: 100%;
        }

        #prompt, #promptSubmit {
            font-size: 1rem;
        }

        #promptSubmit {
            width: 10%;
            cursor: pointer;
        }

        .arg.on-off-button {
            cursor: pointer;
        }

        .arg.on-off-button.active {
            background-color: green;
            color: white;
        }

        .name, .desc {
            border: 1px solid darkslategrey;
            background-color: white;
            color: #053a5f;
        }

        .value {
            float: right;
            color: grey;
            margin-right: .5rem;
        }

        .hidden {
            display: none;
        }

        /********** Range Input Styles **********/
        /*Range Reset*/
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        /* Default cursor when disabled */
        input[type="range"]:disabled {
            cursor: inherit;
        }

        /* Removes default focus */
        input[type="range"]:focus {
            outline: none;
        }

        /***** Chrome, Safari, Opera and Edge Chromium styles *****/
        /* slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            background-color: #053a5f;
            border-radius: 0.5rem;
            height: 0.5rem;
        }

        /* slider thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; /* Override default look */
            appearance: none;
            margin-top: -12px; /* Centers thumb on the track */

            /*custom styles*/
            background-color: #5cd5eb;
            height: 2rem;
            width: 1rem;
        }

        input[type="range"]:focus::-webkit-slider-thumb {
            border: 1px solid #053a5f;
            outline: 3px solid #053a5f;
            outline-offset: 0.125rem;
        }

        /******** Firefox styles ********/
        /* slider track */
        input[type="range"]::-moz-range-track {
            background-color: #053a5f;
            border-radius: 0.5rem;
            height: 0.5rem;
        }

        /* slider thumb */
        input[type="range"]::-moz-range-thumb {
            border: none; /*Removes extra border that FF applies*/
            border-radius: 0; /*Removes default border-radius that FF applies*/

            /*custom styles*/
            background-color: #5cd5eb;
            height: 2rem;
            width: 1rem;
        }

        input[type="range"]:focus::-moz-range-thumb {
            border: 1px solid #053a5f;
            outline: 3px solid #053a5f;
            outline-offset: 0.125rem;
        }

        #status, #patchStatus {
            margin: 1.25rem;
            color: azure;
        }

        #patchStatus {
            margin-bottom: .25rem;
            color: azure;
        }

        #refresh {
            margin: 1.25rem .75rem;
        }

        #refresh button {
            padding: 1rem;
            border-radius: 1rem;
            border: none;
            color: black;
            font-size: 1rem;
            width: 100%;
        }

        #refresh button:hover {
            background-color: lightgreen;
            cursor: pointer;
        }

        #heading {
            text-align: center;
            color: white;
        }
    </style>
</head>
<body>
<div class="outer-wrapper">
    <h1 id="heading"></h1>
    <div id="status" class="hidden"></div>
    <form id="form" action="/"></form>
    <div id="refresh" class="hidden">
        <button onclick="requestUpdate()">Switch parameters</button>
    </div>
    <div id="patchStatus"></div>
    <div id="patchWrapper" class="hidden">
        <hr>
        <form id="patch" action="/">
            <textarea id="prompt" placeholder="Prompt for a new patch"></textarea>
            <input type="submit" id="promptSubmit" value="Create">
        </form>
    </div>
</div>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
    let synthParameters;
    let synthParameterIndex;
    let socketId;
    let refreshHidden;
    const socket = io();
    const heading = document.getElementById('heading');
    const form = document.getElementById('form');
    const patchWrapper = document.getElementById('patchWrapper');
    const patchForm = document.getElementById('patch');
    const status = document.getElementById('status');
    const refresh = document.getElementById('refresh');

    patchForm.addEventListener('submit', function (e) {
        e.preventDefault();
        e.stopPropagation();
        const prompt = document.getElementById('prompt');
        createPatch(prompt.value);
    });

    socket.on('startCreating', function (prompt) {
        const patchStatus = document.getElementById('patchStatus');
        patchStatus.innerText = "Please wait, creating patch. Prompt given: " + prompt;
    });

    socket.on('patchCreated', function (message) {
        patchStatus.innerText = message;
    });

    const requestUpdate = () => {
        refreshHidden = true;
        return socket.emit('requestUpdate', socketId);
    }

    const createPatch = (prompt) => {
        return socket.emit('createPatch', prompt);
    }

    const createSliderWidget = (program, i) => {
        const inputElement = document.createElement("input");
        inputElement.setAttribute("type", "range");
        inputElement.setAttribute("min", program.min);
        inputElement.setAttribute("max", program.max);
        inputElement.setAttribute("step", program.step);
        inputElement.value = program.value;
        inputElement.addEventListener('input', function (e) {
            setAndSendValue(e.target.value, i);
        });
        return inputElement;
    }

    const createButtonWidget = (program, i) => {
        const buttonElement = document.createElement("button");
        buttonElement.innerText = program.value === program.max ? "On" : "Off";
        buttonElement.value = program.value;
        if (program.value === program.max) {
            buttonElement.classList.add('active');
        }
        buttonElement.classList.add('on-off-button');
        buttonElement.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            const value = parseInt(e.target.value) === program.max ? program.min : program.max;
            updateButtonToReflectState(e.target, program, value);
            setAndSendValue(value, i);
        });
        return buttonElement;
    }

    const createSelectWidget = (program, i) => {
        const selectElement = document.createElement("select");
        if (Array.isArray(program.valueMap)) {
            for (let j = program.min; j < program.valueMap.length + program.min; j++) {
                const optionElement = document.createElement("option");
                optionElement.textContent = getDisplayValue(j, i);
                optionElement.value = j;
                optionElement.selected = parseInt(program.value) === j;
                selectElement.appendChild(optionElement);
            }
        } else {
            for (const key in program.valueMap) {
                const optionElement = document.createElement("option");
                optionElement.textContent = program.valueMap[key];
                optionElement.value = key;
                optionElement.selected = program.value === key || parseInt(program.value) === parseInt(key);
                selectElement.appendChild(optionElement);
            }
        }
        selectElement.addEventListener('change', function (e) {
            setAndSendValue(e.target.value, i);
        });
        return selectElement;
    }

    const getElm = (elmType, i) => {
        return document.getElementById(elmType + '-' + i);
    }

    const getDisplayValue = (value, i) => {
        if (isNaN(value) || typeof synthParameters[i].valueMap !== "object") {
            return value;
        }
        let index = parseInt(value) - parseInt(synthParameters[i].min);
        return synthParameters[i].valueMap[index] || value;
    }

    const setAndSendValue = (value, i) => {
        synthParameters[i].value = value;
        getElm('value', i).innerText = value;
        socket.emit('message', i, value);
    }

    const updateButtonToReflectState = (elm, program, value) => {
        if (value === program.max) {
            elm.innerText = "On";
            elm.classList.add('active');
        } else {
            elm.innerText = "Off";
            elm.classList.remove('active');
        }
    }

    const setFormInputs = (name, parameters, assignedControls, assignedParams, hideLabel) => {
        heading.innerText = name; // Set heading
        form.innerHTML = ''; // Clear form
        synthParameters = parameters;
        synthParameterIndex = [];
        // Find assigned parameters
        for (let i = 0; i < synthParameters.length; i++) {
            if (synthParameters[i].sid === socketId) {
                synthParameterIndex.push(i);
            }
        }
        if (synthParameterIndex.length > 0 || assignedControls === false) {
            status.classList.add('hidden');
        }
        for (let i = 0; i < synthParameters.length; i++) {
            const program = synthParameters[i];
            const wrapper = document.createElement("div");
            wrapper.classList.add('wrapper');
            wrapper.setAttribute("id", "wrapper-" + i);
            const valueElement = document.createElement("span");
            valueElement.classList.add('value');
            valueElement.innerText = program.value;
            valueElement.setAttribute("id", "value-" + i);
            const nameElement = document.createElement("div");
            nameElement.classList.add('name');
            nameElement.innerText = program.name;
            nameElement.appendChild(valueElement);
            if (hideLabel) {
                nameElement.classList.add('hidden');
            }
            if (program.description) {
                wrapper.title = program.description;
            }
            let argElement;
            if (typeof program.valueMap === "object") {
                argElement = createSelectWidget(program, i);
            } else if (program.format === "b") {
                argElement = createButtonWidget(program, i);
            } else {
                argElement = createSliderWidget(program, i);
            }
            argElement.classList.add('arg');
            argElement.setAttribute("id", "arg-" + i);
            if (assignedControls === true && !synthParameterIndex.includes(i)) {
                argElement.disabled = true;
            }
            wrapper.appendChild(nameElement);
            wrapper.appendChild(argElement);
            if (assignedParams === true && !synthParameterIndex.includes(i)) {
                wrapper.classList.add('hidden');
            }
            if (assignedControls === true && assignedParams === false && synthParameterIndex.includes(i)) {
                wrapper.classList.add('selected');
            }
            form.appendChild(wrapper);
        }
        if (refreshHidden !== true && (assignedControls === true || assignedParams === true)) {
            refresh.classList.remove('hidden');
        } else {
            refresh.classList.add('hidden');
        }
        if (assignedControls === true) {
            patchWrapper.classList.add('hidden');
        } else {
            patchWrapper.classList.remove('hidden');
        }
    }

    socket.on('setParameters', setFormInputs);

    socket.on('socketId', function (sid) {
        socketId = sid;
    });

    socket.on('status', function (error) {
        status.innerText = error;
        status.classList.remove('hidden');
        refresh.classList.remove('hidden');
    });

    socket.on('value', function (parameterIndex, value) {
        synthParameters[parameterIndex].value = value;
        const arg = getElm('arg', parameterIndex);
        arg.value = value;
        if (arg.classList.contains("on-off-button")) {
            updateButtonToReflectState(arg, synthParameters[parameterIndex], value);
        }
        getElm('value', parameterIndex).innerText = value;
    });

    socket.on('connect', function () {
        socket.emit('ready');
    });
</script>
</body>
</html>
