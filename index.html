<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>OSC</title>
    <style>
        body {
            background-color: steelblue;
        }

        form {
            display: flex;
            flex: auto;
        }

        form input, form select {
            margin: .6rem;
            padding: .6rem;
            border: none;
            width: 100%;
        }

        #address {
            border-radius: 1rem;
        }

        #arg {
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        /********** Range Input Styles **********/
        /*Range Reset*/
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        /* Removes default focus */
        input[type="range"]:focus {
            outline: none;
        }

        /***** Chrome, Safari, Opera and Edge Chromium styles *****/
        /* slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            background-color: #053a5f;
            border-radius: 0.5rem;
            height: 0.5rem;
        }

        /* slider thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; /* Override default look */
            appearance: none;
            margin-top: -12px; /* Centers thumb on the track */

            /*custom styles*/
            background-color: #5cd5eb;
            height: 2rem;
            width: 1rem;
        }

        input[type="range"]:focus::-webkit-slider-thumb {
            border: 1px solid #053a5f;
            outline: 3px solid #053a5f;
            outline-offset: 0.125rem;
        }

        /******** Firefox styles ********/
        /* slider track */
        input[type="range"]::-moz-range-track {
            background-color: #053a5f;
            border-radius: 0.5rem;
            height: 0.5rem;
        }

        /* slider thumb */
        input[type="range"]::-moz-range-thumb {
            border: none; /*Removes extra border that FF applies*/
            border-radius: 0; /*Removes default border-radius that FF applies*/

            /*custom styles*/
            background-color: #5cd5eb;
            height: 2rem;
            width: 1rem;
        }

        input[type="range"]:focus::-moz-range-thumb {
            border: 1px solid #053a5f;
            outline: 3px solid #053a5f;
            outline-offset: 0.125rem;
        }

        #status {
            margin: 1.25rem;
            color: azure;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <form id="form" action="/">
        <select id="address"></select>
        <input type="range" id="arg" min="0" max="1" step="0.01"/>
    </form>
    <div id="status" class="hidden"></div>
</div>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
    let synthParameters;
    let synthParameterIndex;
    const socket = io();
    const form = document.getElementById('form');
    const address = document.getElementById('address');
    const arg = document.getElementById('arg');
    const status = document.getElementById('status');

    const sendOsc = () => {
        if (address.value) {
            socket.emit('message', address.value, arg.value, synthParameterIndex);
        }
    }

    const setFormInputs = (parameters, parameterIndex, hideAddress) => {
        address.classList.remove('hidden');
        arg.classList.remove('hidden');
        status.classList.add('hidden');
        synthParameters = parameters;
        synthParameterIndex = parameterIndex;
        if (address.type === 'select-one') {
            address.innerHTML = '';
            for (let i = 0; i < synthParameters.length; i++) {
                let optionElement = document.createElement("option");
                optionElement.textContent = synthParameters[i].name ?? synthParameters[i].address;
                optionElement.value = synthParameters[i].address;
                address.appendChild(optionElement);
            }
            if (hideAddress === true) {
                address.classList.add('hidden');
            }
        }
        let program = synthParameters[synthParameterIndex];
        if (program.description) {
            status.classList.remove('hidden');
            status.innerText = program.description;
        }
        address.value = program.address;
        arg.min = program.min;
        arg.max = program.max;
        arg.step = program.step;
        arg.value = program.value;
        //sendOsc();
    }

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        sendOsc();
    });

    address.addEventListener('change', function (e) {
        for (let i = 0; i < synthParameters.length; i++) {
            if (synthParameters[i].address === e.target.value) {
                setFormInputs(synthParameters, i);
                break;
            }
        }
    });

    arg.addEventListener('input', function (e) {
        synthParameters[synthParameterIndex].value = e.target.value;
        sendOsc();
    });

    socket.on('message', setFormInputs);

    socket.on('status', function (error) {
        address.classList.add('hidden');
        arg.classList.add('hidden');
        status.classList.remove('hidden');
        status.innerText = error;
    });

    socket.on('value', function (parameterIndex, value) {
        synthParameters[parameterIndex].value = value;
        if (synthParameterIndex === parameterIndex) {
            arg.value = synthParameters[synthParameterIndex].value;
        }
        //console.log('parameter updated', parameterIndex, value);
    });

    socket.on('connect', function () {
        // sends to socket.io server the host/port of oscServer and oscClient
        socket.emit('config',
            {
                /*server: {
                    port: 3333,
                    host: 'localhost'
                },*/
                client: {
                    port: 3334,
                    host: 'localhost'
                }
            }
        );
    });
</script>
</body>
</html>
