<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>OSC</title>
    <style>
        body {
            background-color: steelblue;
            font-family: Courier, monospace;
        }

        .wrapper {
            display: flex;
            flex: auto;
        }

        .wrapper.selected {
            background-color: lightgreen;
        }

        .arg, .name, .desc {
            border-radius: 1rem;
            margin: .6rem;
            padding: .6rem;
            border: none;
            width: 100%;
        }

        .arg.on-off-button {
            cursor: pointer;
        }

        .arg.on-off-button.active {
            background-color: green;
            color: white;
        }

        .name, .desc {
            border: 1px solid darkslategrey;
            background-color: white;
            color: #053a5f;
        }

        .value {
            float: right;
            color: grey;
            margin-right: .5rem;
        }

        .hidden {
            display: none;
        }

        /********** Range Input Styles **********/
        /*Range Reset*/
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        /* Default cursor when disabled */
        input[type="range"]:disabled {
            cursor: inherit;
        }

        /* Removes default focus */
        input[type="range"]:focus {
            outline: none;
        }

        /***** Chrome, Safari, Opera and Edge Chromium styles *****/
        /* slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            background-color: #053a5f;
            border-radius: 0.5rem;
            height: 0.5rem;
        }

        /* slider thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; /* Override default look */
            appearance: none;
            margin-top: -12px; /* Centers thumb on the track */

            /*custom styles*/
            background-color: #5cd5eb;
            height: 2rem;
            width: 1rem;
        }

        input[type="range"]:focus::-webkit-slider-thumb {
            border: 1px solid #053a5f;
            outline: 3px solid #053a5f;
            outline-offset: 0.125rem;
        }

        /******** Firefox styles ********/
        /* slider track */
        input[type="range"]::-moz-range-track {
            background-color: #053a5f;
            border-radius: 0.5rem;
            height: 0.5rem;
        }

        /* slider thumb */
        input[type="range"]::-moz-range-thumb {
            border: none; /*Removes extra border that FF applies*/
            border-radius: 0; /*Removes default border-radius that FF applies*/

            /*custom styles*/
            background-color: #5cd5eb;
            height: 2rem;
            width: 1rem;
        }

        input[type="range"]:focus::-moz-range-thumb {
            border: 1px solid #053a5f;
            outline: 3px solid #053a5f;
            outline-offset: 0.125rem;
        }

        #status {
            margin: 1.25rem;
            color: azure;
        }

        #refresh {
            margin: 1.25rem .75rem;
        }

        #refresh button {
            padding: 1rem;
            border-radius: 1rem;
            border: none;
            color: black;
            font-size: 1rem;
            width: 100%;
        }

        #refresh button:hover {
            background-color: lightgreen;
            cursor: pointer;
        }

        #heading {
            text-align: center;
            color: white;
        }
    </style>
</head>
<body>
<div class="outer-wrapper">
    <h1 id="heading"></h1>
    <form id="form" action="/"></form>
    <div id="status" class="hidden"></div>
    <div id="refresh" class="hidden">
        <button onclick="location.reload()">Change Parameter</button>
    </div>
</div>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
    let synthParameters;
    let synthParameterIndex;
    const socket = io();
    const heading = document.getElementById('heading');
    const form = document.getElementById('form');
    const status = document.getElementById('status');
    const refresh = document.getElementById('refresh');

    const getElm = (elmType, i) => {
        return document.getElementById(elmType + '-' + i);
    }

    const getDisplayValue = (value, i) => {
        if (isNaN(value) || typeof synthParameters[i].valueMap !== "object") {
            return value;
        }
        let index = parseInt(value) - parseInt(synthParameters[i].min);
        return synthParameters[i].valueMap[index] || value;
    }

    const setAndSendValue = (value, i) => {
        synthParameters[i].value = value;
        getElm('value', i).innerText = value;
        socket.emit('message', i, value);
    }

    const updateButtonToReflectValue = (elm, program, value) => {
        if (value === program.max) {
            elm.innerText = "On";
            elm.classList.add('active');
        } else {
            elm.innerText = "Off";
            elm.classList.remove('active');
        }
    }

    const setFormInputs = (name, parameters, parameterIndex, singleControl, singleParam, hideLabel) => {
        status.classList.add('hidden');
        heading.innerText = name;
        synthParameters = parameters;
        synthParameterIndex = parameterIndex;
        form.innerHTML = ''; // Clear form
        for (let i = 0; i < synthParameters.length; i++) {
            let program = synthParameters[i];
            let wrapper = document.createElement("div");
            wrapper.classList.add('wrapper');
            wrapper.setAttribute("id", "wrapper-" + i);
            let valueElement = document.createElement("span");
            valueElement.classList.add('value');
            valueElement.innerText = program.value;
            valueElement.setAttribute("id", "value-" + i);
            let nameElement = document.createElement("div");
            nameElement.classList.add('name');
            nameElement.innerText = program.name;
            nameElement.appendChild(valueElement);
            if (hideLabel) {
                nameElement.classList.add('hidden');
            }
            if (program.description) {
                wrapper.title = program.description;
            }
            let argElement;
            if (typeof program.valueMap === "object") {
                argElement = document.createElement("select");
                for (let j = program.min; j < program.valueMap.length + program.min; j++) {
                    let optionElement = document.createElement("option");
                    optionElement.textContent = getDisplayValue(j, i);
                    optionElement.value = j;
                    optionElement.selected = parseInt(program.value) === j;
                    argElement.appendChild(optionElement);
                }
                argElement.addEventListener('change', function (e) {
                    setAndSendValue(e.target.value, i);
                });
            } else if (program.format === "b") {
                argElement = document.createElement("button");
                argElement.innerText = program.value === program.max ? "On" : "Off";
                argElement.value = program.value;
                if (program.value === program.max) {
                    argElement.classList.add('active');
                }
                argElement.classList.add('on-off-button');
                argElement.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    let value = parseInt(e.target.value) === program.max ? program.min : program.max;
                    updateButtonToReflectValue(e.target, program, value);
                    setAndSendValue(value, i);
                });
            } else {
                argElement = document.createElement("input");
                argElement.setAttribute("type", "range");
                argElement.setAttribute("min", program.min);
                argElement.setAttribute("max", program.max);
                argElement.setAttribute("step", program.step);
                argElement.value = program.value;
                argElement.addEventListener('input', function (e) {
                    setAndSendValue(e.target.value, i);
                });
            }
            argElement.classList.add('arg');
            argElement.setAttribute("id", "arg-" + i);
            if (singleControl === true && i !== synthParameterIndex) {
                argElement.disabled = true;
            }
            wrapper.appendChild(nameElement);
            wrapper.appendChild(argElement);
            if (singleParam === true && i !== synthParameterIndex) {
                wrapper.classList.add('hidden');
            }
            if (singleControl === true && singleParam === false && i === synthParameterIndex) {
                wrapper.classList.add('selected');
            }
            form.appendChild(wrapper);
        }
        if (singleControl === true || singleParam === true) {
            refresh.classList.remove('hidden');
        } else {
            refresh.classList.add('hidden');
        }
    }

    socket.on('message', setFormInputs);

    socket.on('status', function (error) {
        status.innerText = error;
        status.classList.remove('hidden');
        refresh.classList.remove('hidden');
    });

    socket.on('value', function (parameterIndex, value) {
        synthParameters[parameterIndex].value = value;
        const arg = getElm('arg', parameterIndex);
        arg.value = value;
        if (arg.classList.contains("on-off-button")) {
            updateButtonToReflectValue(arg, synthParameters[parameterIndex], value);
        }
        getElm('value', parameterIndex).innerText = value;
    });

    socket.on('connect', function () {
        // sends to socket.io server the host/port of oscServer and oscClient
        socket.emit('config',
            {
                /*server: {
                    port: 3333,
                    host: 'localhost'
                },*/
                client: {
                    port: 3334,
                    host: 'localhost'
                }
            }
        );
    });
</script>
</body>
</html>
